<?xml version="1.0" encoding="utf-8" ?>
<views:ContentBasePage xmlns="http://xamarin.com/schemas/2014/forms"
                       xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                       xmlns:resx="clr-namespace:IdApp.Resx;assembly=IdApp"
                       xmlns:converters="clr-namespace:IdApp.Converters;assembly=IdApp"
                       xmlns:views="clr-namespace:IdApp.Pages;assembly=IdApp"
                       xmlns:mainTabBar="clr-namespace:IdApp.Controls.MainTabBar;assembly=IdApp"
                       xmlns:model="clr-namespace:IdApp.Pages.Wallet.MyWallet;assembly=IdApp"
                       xmlns:objectmodel="clr-namespace:IdApp.Pages.Wallet;assembly=IdApp"
                       xmlns:flipView="clr-namespace:IdApp.Controls.FlipView;assembly=IdApp"
                       x:DataType="model:MyWalletViewModel"
                       x:Class="IdApp.Pages.Wallet.MyWallet.MyWalletPage"
                       Title="{x:Static resx:AppResources.Wallet}">
    <flipView:FlipView HorizontalOptions="FillAndExpand" VerticalOptions="FillAndExpand" x:Name="WalletFlipView" BackViewShowing="WalletFlipView_BackViewShowing">
        <flipView:FlipView.GestureRecognizers>
            <TapGestureRecognizer Tapped="WalletFlipView_Tapped" />
        </flipView:FlipView.GestureRecognizers>
        <flipView:FlipView.FrontView>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="200"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Frame Grid.Column="0" Grid.Row="0" HeightRequest="150" BorderColor="Black" CornerRadius="6" HasShadow="True" Margin="5"
                       BackgroundColor="{StaticResource HeadingBackground}">
                    <Grid HeightRequest="150" WidthRequest="10000">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="25"/>
                            <RowDefinition Height="100"/>
                            <RowDefinition Height="25"/>
                        </Grid.RowDefinitions>
                        <Image x:Name="ImgFront" Grid.Column="0" Grid.Row="0" Grid.RowSpan="3" Source="{Binding Path=EDalerFrontGlyph}" Opacity="0.5"/>
                        <Label Grid.Column="0" Grid.Row="0" Text="{Binding Path=Timestamp, Converter={converters:DateTimeToStringConverter}}" HorizontalOptions="StartAndExpand" TextColor="{StaticResource HeadingForeground}"/>
                        <Label Grid.Column="0" Grid.Row="1" HorizontalOptions="Center" VerticalOptions="Center" TextColor="{StaticResource HeadingForeground}">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="{Binding Path=Amount, Converter={converters:MoneyToString}}" FontSize="50" FontAttributes="Bold"/>
                                    <Span Text=" "/>
                                    <Span Text="{Binding Path=Currency}" FontSize="30"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                        <Label Grid.Column="0" Grid.Row="2" IsVisible="{Binding Path=HasPending}" HorizontalOptions="Start" TextColor="{StaticResource PendingColor}">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="(-"/>
                                    <Span Text="{Binding Path=PendingAmount, Converter={converters:MoneyToString}}" FontAttributes="Bold"/>
                                    <Span Text=" "/>
                                    <Span Text="{Binding Path=PendingCurrency}"/>
                                    <Span Text=")"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </Grid>
                </Frame>

                <ScrollView Grid.Column="0" Grid.Row="1">
                    <StackLayout Margin="{StaticResource DefaultMargin}" Spacing="16">
                        <StackLayout x:Name="PendingPaymentsLayout" IsVisible="{Binding Path=HasPending}"
                             Spacing="16" Orientation="Vertical" VerticalOptions="Start"
                             BindableLayout.ItemsSource="{Binding Path=PendingPayments}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="model:PendingPaymentItem">
                                    <Grid ColumnDefinitions="2*,*" RowDefinitions="auto,auto">
                                        <Label Grid.Column="0" Grid.Row="0" Text="{Binding Path=FriendlyName}" Style="{StaticResource KeyLabel}" LineBreakMode="TailTruncation" FontAttributes="Bold" FontSize="18"/>
                                        <Label Grid.Column="0" Grid.Row="1" Text="{Binding Path=ExpiresStr}" Style="{StaticResource KeyLabel}" LineBreakMode="TailTruncation" FontAttributes="Italic"/>
                                        <Label Grid.Column="1" Grid.Row="0" Grid.RowSpan="2" LineBreakMode="TailTruncation" TextColor="{StaticResource PendingColor}" HorizontalTextAlignment="End">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="-" FontSize="30" FontAttributes="Bold"/>
                                                    <Span Text="{Binding Path=Amount, Converter={converters:MoneyToString}}" FontSize="30" FontAttributes="Bold"/>
                                                    <Span Text=" "/>
                                                    <Span Text="{Binding Path=Currency}" FontSize="20"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Path=BindingContext.ShowPendingCommand, Source={x:Reference PendingPaymentsLayout}}" CommandParameter="{Binding}" />
                                        </Grid.GestureRecognizers>
                                    </Grid>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </StackLayout>

                        <StackLayout x:Name="AccountEventsLayout" IsVisible="{Binding Path=HasEvents}"
                             Spacing="16" Orientation="Vertical" VerticalOptions="StartAndExpand"
                             BindableLayout.ItemsSource="{Binding Path=Events}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="objectmodel:AccountEventItem">
                                    <Grid ColumnDefinitions="2*,*" RowDefinitions="auto,auto,auto">
                                        <Label Grid.Column="0" Grid.Row="0" Text="{Binding Path=FriendlyName}" Style="{StaticResource KeyLabel}" LineBreakMode="TailTruncation" FontAttributes="Bold" FontSize="18"/>
                                        <Label Grid.Column="0" Grid.Row="1" Text="{Binding Path=TimestampStr}" Style="{StaticResource KeyLabel}" LineBreakMode="TailTruncation"/>
                                        <Label Grid.Column="1" Grid.Row="0" LineBreakMode="TailTruncation" HorizontalTextAlignment="End">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding Path=Change, Converter={converters:MoneyToString}}" FontSize="18" FontAttributes="Bold" TextColor="{Binding Path=TextColor}"/>
                                                    <Span Text=" "/>
                                                    <Span Text="{Binding Path=Currency}" FontSize="16" TextColor="{Binding Path=TextColor}"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                        <Label Grid.Column="1" Grid.Row="1" LineBreakMode="TailTruncation" HorizontalTextAlignment="End">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text=" ("/>
                                                    <Span Text="{Binding Path=Balance, Converter={converters:MoneyToString}}" FontSize="14"/>
                                                    <Span Text=" "/>
                                                    <Span Text="{Binding Path=Currency}" FontSize="12"/>
                                                    <Span Text=" ) "/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                        <Label Grid.Column="0" Grid.Row="2" Text="{Binding Path=Message}" IsVisible="{Binding Path=HasMessage}" LineBreakMode="TailTruncation"/>
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Path=BindingContext.ShowEventCommand, Source={x:Reference AccountEventsLayout}}" CommandParameter="{Binding}" />
                                        </Grid.GestureRecognizers>
                                    </Grid>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </StackLayout>
                    </StackLayout>
                </ScrollView>

                <mainTabBar:MainTabBarView x:Name="WalletFrontTabBar"
                                           Grid.Column="0" Grid.Row="2" 
                                           LeftButton1Text="{x:Static resx:FontAwesome.ArrowLeft}"
                                           LeftButton2Text="{x:Static resx:FontAwesome.Rotate}"
                                           CenterButtonText="{x:Static resx:FontAwesome.ScanQr}" 
                                           RightButton1Text="{x:Static resx:FontAwesome.HandHolding}" 
                                           RightButton2Text="{x:Static resx:FontAwesome.MoneyBill}" 
                                           LeftButton1Command="{Binding Path=BackCommand}" 
                                           LeftButton2Command="{Binding Path=FlipCommand}"
                                           CenterButtonCommand="{Binding Path=ScanQrCodeCommand}"
                                           RightButton1Command="{Binding Path=RequestPaymentCommand}"
                                           RightButton2Command="{Binding Path=MakePaymentCommand}"/>
            </Grid>
        </flipView:FlipView.FrontView>
        <flipView:FlipView.BackView>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="200"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Frame Grid.Column="0" Grid.Row="0" HeightRequest="150" BorderColor="Black" CornerRadius="6" HasShadow="True" Margin="5"
                       BackgroundColor="{StaticResource HeadingBackground}">
                    <Grid HeightRequest="150" WidthRequest="10000">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="25"/>
                            <RowDefinition Height="125"/>
                        </Grid.RowDefinitions>
                        <Image x:Name="ImgBack" Grid.Column="0" Grid.Row="0" Grid.RowSpan="3" Source="{Binding Path=EDalerBackGlyph}" Opacity="0.5"/>
                        <Label Grid.Column="0" Grid.Row="0" Text="{Binding Path=Timestamp, Converter={converters:DateTimeToStringConverter}}" HorizontalOptions="StartAndExpand" TextColor="{StaticResource HeadingForeground}"/>
                        <StackLayout Grid.Column="0" Grid.Row="1" x:Name="TokenTotalsLayout" IsVisible="{Binding Path=HasTotals}"
                             Spacing="16" Orientation="Vertical" VerticalOptions="StartAndExpand"
                             BindableLayout.ItemsSource="{Binding Path=Totals}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="objectmodel:TokenTotalItem">
                                    <Grid ColumnDefinitions="*,*,*" RowDefinitions="auto">
                                        <Label Grid.Column="0" Grid.Row="0" Text="{Binding Path=Total, Converter={converters:MoneyToString}}" Style="{StaticResource KeyLabel}" LineBreakMode="TailTruncation" FontAttributes="Bold" FontSize="18"/>
                                        <Label Grid.Column="1" Grid.Row="0" Text="{Binding Path=Currency}" Style="{StaticResource KeyLabel}" LineBreakMode="TailTruncation" HorizontalTextAlignment="End"/>
                                        <Label Grid.Column="2" Grid.Row="0" LineBreakMode="TailTruncation" HorizontalTextAlignment="End">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="("/>
                                                    <Span Text="{Binding Path=NrTokens}"/>
                                                    <Span Text=")"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </Grid>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </StackLayout>
                    </Grid>
                </Frame>

                <ScrollView Grid.Column="0" Grid.Row="1">
                    <StackLayout Margin="{StaticResource DefaultMargin}" Spacing="16">
                    </StackLayout>
                </ScrollView>

                <mainTabBar:MainTabBarView x:Name="WalletBackTabBar"
                                           Grid.Column="0" Grid.Row="2" 
                                           LeftButton1Text="{x:Static resx:FontAwesome.ArrowLeft}"
                                           LeftButton2Text="{x:Static resx:FontAwesome.Rotate}"
                                           CenterButtonText="{x:Static resx:FontAwesome.ScanQr}" 
                                           LeftButton1Command="{Binding Path=BackCommand}" 
                                           LeftButton2Command="{Binding Path=FlipCommand}" 
                                           CenterButtonCommand="{Binding Path=ScanQrCodeCommand}"/>
            </Grid>
        </flipView:FlipView.BackView>
    </flipView:FlipView>
</views:ContentBasePage>